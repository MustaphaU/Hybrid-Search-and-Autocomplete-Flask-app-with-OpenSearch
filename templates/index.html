{% extends 'base.html' %}

{% block content %}
<form method="POST" action="{{ url_for('handle_search') }}">
    <div class="mb-3 position-relative">
        <input type="text" class="form-control" name="query" id="query" placeholder="Enter your search query" value="{{ query }}" autocomplete="off" autofocus>
        <ul id="autocomplete-dropdown" class="dropdown-menu" style="width:100%; display:none; position:absolute; z-index:1000;"></ul>
    </div>
</form>
<script>
    // Autocomplete logic
    const input = document.getElementById('query');
    const dropdown = document.getElementById('autocomplete-dropdown');

    let lastTerm = "";
    input.addEventListener('input', async function (e) {
        let val = e.target.value.trim();
        lastTerm = val;
        if (val.length < 2) {
            dropdown.style.display = 'none';
            return;
        }
        const resp = await fetch('/autocomplete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'query=' + encodeURIComponent(val)
        });
        const suggestions = await resp.json();

        dropdown.innerHTML = '';
        if (suggestions.length === 0) {
            dropdown.style.display = 'none';
            return;
        }
        suggestions.forEach(s => {
            const li = document.createElement('li');
            li.className = "dropdown-item";
            li.innerHTML = `<strong>${s.name || ""}</strong> <small class="text-muted">${s.category || ""}</small>`;
            li.style.cursor = "pointer";
            li.onclick = () => {
                input.value = s.name;
                dropdown.style.display = 'none';
                input.form.submit(); //submit search
            };
            dropdown.appendChild(li);
        });
        dropdown.style.display = 'block';
    });
    //hide dropdown on click outside i.e. not on input(searchbox) or dropdown
    document.addEventListener('click', function (event) {
        if (!input.contains(event.target) && !dropdown.contains(event.target)) {
            dropdown.style.display = 'none';
        }
    });

    // up/down arrrow key navigation
    input.addEventListener('keydown', function (e) {
        const items = dropdown.querySelectorAll('.dropdown-item');
        let idx = Array.from(items).findIndex(item => item.classList.contains('active'));
        if (e.key === "ArrowDown") {
            if (idx < items.length - 1) idx++;
            else idx = 0;
            items.forEach(item => item.classList.remove('active'));
            if (items[idx]) {
                items[idx].classList.add('active');
                items[idx].scrollIntoView({ block: 'nearest' });
            }
            e.preventDefault();
        } else if (e.key === "ArrowUp") {
            if (idx > 0) idx--;
            else idx = items.length - 1;
            items.forEach(item => item.classList.remove('active'));
            if (items[idx]) {
                items[idx].classList.add('active');
                items[idx].scrollIntoView({ block: 'nearest' });
            }
            e.preventDefault();
        } else if (e.key === "Enter" && idx !== -1) {
            items[idx].click();
            e.preventDefault();
        }
    }
    );

</script>
{% if results %}
<div class="row mb-3">
    <div class="col-2 mt-2">
        <p><a href="javascript:history.back(1)">← Back</a></p>
        {% for agg in aggs %}
        <h6 class="mt-3">{{ agg }}</h6>
        {% for key, count in aggs[agg].items() %}
        <form method="POST">
            <input type="hidden" name="query" value="{{ agg|lower }}:{{key}} {{ query }}">
            <button type="submit" class="btn btn-link btn-sm" {% if aggs[agg]|length==1 %} disabled{% endif %}>{{ key }}
                ({{ count }})</button>
        </form>
        {% endfor %}
        {% endfor %}
    </div>
    <div class="col-10">
        <div class="row mb-3">
            <div class="col-sm-auto my-auto">
                Showing results {{ from_ + 1 }}-{{ from_ + results|length }} out of {{ total }}.
            </div>
            {% if from_ > 0 %}
            <div class="col-sm-auto my-auto">
                <a href="javascript:history.back(1)" class="btn btn-primary">← Previous page</a>
            </div>
            {% endif %}
            {% if from_ + results|length < total %} <div class="col-sm-auto my-auto">
                <form method="POST">
                    <input type="hidden" name="query" value="{{ query }}">
                    <input type="hidden" name="from_" value="{{ from_ + results|length }}">
                    <button type="submit" class="btn btn-primary">Next page →</button>
                </form>
        </div>
        {% endif %}
        <div class="col"></div>
    </div>
    {% for result in results %}
    <p>
        {{ from_ + loop.index }}. <b><a href="{{ url_for('get_document', id=result._id) }}">{{ result._source.name
                }}</a></b>
        <br>
        {{ result._source.summary }}
        <br>
        <small>
            Category: {{ result._source.category }}.
            Last updated: {{ result._source.updated_at | default(result._source.created_on) }}.
            {% if result._score %}<i>(Score: {{ result._score }})</i>{% endif %}
        </small>
    </p>
    {% endfor %}
</div>
</div>
{% elif request.method == 'POST' %}
<p>No results found.</p>
{% endif %}
{% endblock %}